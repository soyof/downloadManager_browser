name: Auto Release

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'package.json'
      - 'public/manifest.json'

# 配置工作流权限
permissions:
  contents: write # 允许创建 tag 和 release
  actions: read # 允许读取工作流状态

jobs:
  detect-version-change:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      changed: ${{ steps.check.outputs.changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Check if version changed
        id: check
        run: |
          CURRENT_VERSION="${{ steps.version.outputs.version }}"

          # 获取最新的 tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LATEST_TAG" ]; then
            echo "No existing tags found, version changed"
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            # 移除 'v' 前缀（如果有）
            LATEST_VERSION=${LATEST_TAG#v}
            
            if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
              echo "Version changed from $LATEST_VERSION to $CURRENT_VERSION"
              echo "changed=true" >> $GITHUB_OUTPUT
            else
              echo "Version unchanged: $CURRENT_VERSION"
              echo "changed=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Verify manifest.json version matches
        if: steps.check.outputs.changed == 'true'
        run: |
          PKG_VERSION="${{ steps.version.outputs.version }}"
          MANIFEST_VERSION=$(node -p "require('./public/manifest.json').version")

          if [ "$PKG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "Error: package.json version ($PKG_VERSION) does not match manifest.json version ($MANIFEST_VERSION)"
            exit 1
          fi
          echo "Version consistency check passed: $PKG_VERSION"

  create-tag:
    needs: detect-version-change
    if: needs.detect-version-change.outputs.changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要写入权限来创建和推送 tag
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create tag
        id: tag
        run: |
          VERSION="${{ needs.detect-version-change.outputs.version }}"
          TAG_NAME="v${VERSION}"

          # 检查 tag 是否已存在
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping creation"
            echo "created=false" >> $GITHUB_OUTPUT
            echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          else
            git tag -a "$TAG_NAME" -m "Release version $VERSION"
            git push origin "$TAG_NAME"
            echo "Tag $TAG_NAME created and pushed"
            echo "created=true" >> $GITHUB_OUTPUT
            echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          fi

  create-release:
    needs: [detect-version-change, create-tag]
    if: needs.detect-version-change.outputs.changed == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write # 需要写入权限来创建 release 和上传文件
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Extract changelog content
        id: changelog
        run: |
          VERSION="${{ needs.detect-version-change.outputs.version }}"

          # 读取 CHANGELOG.md 并提取对应版本的内容
          if [ -f CHANGELOG.md ]; then
            # 使用 awk 提取版本块（从 ## [version] 到下一个 ## 或文件结束）
            awk -v version="$VERSION" '
              BEGIN { in_version = 0 }
              /^## \[/ {
                if (in_version) exit
                if ($0 ~ "\\[" version "\\]") {
                  in_version = 1
                  next
                }
              }
              in_version {
                print
              }
            ' CHANGELOG.md > changelog_content.txt
            
            # 检查是否提取到内容
            if [ -s changelog_content.txt ]; then
              echo "Extracted changelog for version $VERSION"
              # 使用多行输出到 GitHub Actions
              {
                echo "content<<EOF"
                cat changelog_content.txt
                echo "EOF"
              } >> $GITHUB_OUTPUT
            else
              echo "No changelog found for version $VERSION, using default"
              {
                echo "content<<EOF"
                echo "### 变更内容"
                echo "查看 [提交历史](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}) 了解详细变更"
                echo "EOF"
              } >> $GITHUB_OUTPUT
            fi
          else
            echo "CHANGELOG.md not found, using default"
            {
              echo "content<<EOF"
              echo "### 变更内容"
              echo "查看 [提交历史](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }}) 了解详细变更"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          fi

      - name: Install crx package
        run: npm install -g crx

      - name: Generate or use private key
        run: |
          if [ -z "${{ secrets.CRX_PRIVATE_KEY }}" ]; then
            echo "Generating new private key..."
            openssl genrsa -out key.pem 2048
          else
            echo "${{ secrets.CRX_PRIVATE_KEY }}" > key.pem
          fi

      - name: Build CRX file
        run: |
          VERSION="${{ needs.detect-version-change.outputs.version }}"
          CRX_NAME="download-manager-v${VERSION}.crx"

          # 使用 crx 工具打包
          crx pack dist -o "$CRX_NAME" -p key.pem || {
            echo "crx pack failed, creating unsigned crx..."
            # 如果 crx 工具失败，创建未签名的 crx
            cd dist
            zip -r ../extension.zip .
            cd ..
            # 将 zip 重命名为 crx（未签名，但可以手动安装）
            mv extension.zip "$CRX_NAME"
          }

          echo "CRX file created: $CRX_NAME"
          ls -lh "$CRX_NAME"

      - name: Create zip archive (fallback)
        run: |
          VERSION="${{ needs.detect-version-change.outputs.version }}"
          cd dist
          zip -r ../download-manager-v${VERSION}.zip .
          cd ..

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.detect-version-change.outputs.version }}
          name: Release v${{ needs.detect-version-change.outputs.version }}
          body: |
            ## 版本 ${{ needs.detect-version-change.outputs.version }}

            ${{ steps.changelog.outputs.content }}

            ### 安装说明
            1. 下载 `download-manager-v${{ needs.detect-version-change.outputs.version }}.crx` 文件
            2. 打开 Chrome/Edge，访问 `chrome://extensions/` 或 `edge://extensions/`
            3. 开启"开发者模式"
            4. 将下载的 `.crx` 文件拖拽到扩展程序页面即可安装
            5. 如果无法安装 crx 文件，可以下载 zip 文件并手动加载

            ### 注意事项
            - 此版本为开发版本，正式版本请从 Chrome Web Store 安装
            - 如果浏览器提示"无法添加扩展程序"，请下载 zip 版本并手动加载
          files: |
            download-manager-v${{ needs.detect-version-change.outputs.version }}.crx
            download-manager-v${{ needs.detect-version-change.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
